<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Glassy Speed Test</title>
  <style>
    :root{
      --bg1:#07152b;
      --bg2:#0a2a5a;
      --glass: rgba(255,255,255,.08);
      --glass2: rgba(255,255,255,.12);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --blue:#4aa3ff;
      --blue2:#2f7dff;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 16px 50px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(74,163,255,.35), transparent 55%),
        radial-gradient(900px 700px at 80% 20%, rgba(47,125,255,.25), transparent 55%),
        radial-gradient(800px 600px at 50% 90%, rgba(255,255,255,.07), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:26px 16px 40px;
    }
    .topbar{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:18px;
    }
    .brand{
      display:flex; gap:12px; align-items:center;
    }
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, rgba(74,163,255,.9), rgba(47,125,255,.75));
      box-shadow: 0 10px 30px rgba(74,163,255,.25);
      position:relative;
      overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 55%);
      transform: rotate(20deg);
      opacity:.75;
    }
    .title{
      line-height:1.05;
    }
    .title h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .title p{
      margin:3px 0 0;
      color:var(--muted);
      font-size:12px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:16px;
    }
    @media (max-width: 960px){
      .grid{grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, var(--glass), rgba(255,255,255,.06));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      overflow:hidden;
    }
    .card .head{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .card .head .h{
      font-weight:700;
      font-size:13px;
      letter-spacing:.3px;
    }
    .pill{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:99px;
      background: rgba(255,255,255,.35);
      box-shadow: 0 0 0 4px rgba(255,255,255,.06);
    }

    .content{ padding:16px; }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      margin-bottom:12px;
    }
    @media (max-width: 560px){
      .row{ grid-template-columns: 1fr; }
    }
    .stat{
      padding:14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
    }
    .stat .k{
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .stat .v{
      margin-top:8px;
      font-size:28px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .unit{ font-size:12px; color:var(--muted); font-weight:600; }
    .mini{ font-size:12px; color:var(--muted); margin-top:6px; }

    .controls{
      display:grid;
      grid-template-columns: 1.2fr 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    @media (max-width: 820px){
      .controls{ grid-template-columns: 1fr; }
    }
    label{
      font-size:12px;
      color:var(--muted);
      display:block;
      margin:0 0 6px 2px;
    }
    select, button{
      width:100%;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:12px 12px;
      outline:none;
      font-size:14px;
    }
    select:disabled, button:disabled{ opacity:.55; cursor:not-allowed; }
    button{
      font-weight:800;
      border:none;
      background: linear-gradient(135deg, rgba(74,163,255,.95), rgba(47,125,255,.85));
      box-shadow: 0 14px 30px rgba(47,125,255,.25);
      cursor:pointer;
      transition: transform .08s ease;
    }
    button:active{ transform: translateY(1px) scale(.995); }
    .btn2{
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.16);
      box-shadow:none;
      font-weight:700;
    }

    .chartWrap{
      height:260px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding:10px;
    }
    canvas{ width:100%; height:100%; display:block; }

    .log{
      margin-top:12px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
      white-space:pre-wrap;
      min-height:52px;
    }
    .hint{
      color:var(--muted);
      font-size:12px;
      margin-top:10px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <h1>Glassy Speed Test</h1>
          <p>Ping real-time • Download/Upload • Data cap • Chart live</p>
        </div>
      </div>
      <div class="pill" id="statusPill"><span class="dot" id="statusDot"></span><span id="statusText">Idle</span></div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="head">
          <div class="h">Live Results</div>
          <div class="pill">Server: <b style="color:var(--text)">local</b></div>
        </div>
        <div class="content">
          <div class="row">
            <div class="stat">
              <div class="k">Ping <span class="unit">ms</span></div>
              <div class="v" id="pingVal">--</div>
              <div class="mini" id="pingNote">real-time</div>
            </div>
            <div class="stat">
              <div class="k">Download <span class="unit">Mbps</span></div>
              <div class="v" id="downVal">--</div>
              <div class="mini" id="downNote">—</div>
            </div>
            <div class="stat">
              <div class="k">Upload <span class="unit">Mbps</span></div>
              <div class="v" id="upVal">--</div>
              <div class="mini" id="upNote">—</div>
            </div>
          </div>

          <div class="chartWrap">
            <canvas id="chart"></canvas>
          </div>

          <div class="controls">
            <div>
              <label>Mode test</label>
              <select id="mode">
                <option value="download">Download</option>
                <option value="upload">Upload</option>
                <option value="both">Download + Upload</option>
              </select>
            </div>
            <div>
              <label>Data cap (MB) — auto stop</label>
              <select id="cap">
                <option value="20">20 MB</option>
                <option value="50" selected>50 MB</option>
                <option value="100">100 MB</option>
              </select>
            </div>
            <div>
              <label>Kontrol</label>
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button id="startBtn">Start Test</button>
                <button id="stopBtn" class="btn2" disabled>Stop</button>
              </div>
            </div>
          </div>

          <div class="log" id="log">Ready.</div>
          <div class="hint">Catatan: kalau pilih “Download + Upload”, cap dibagi rata (contoh 50MB = 25MB download + 25MB upload).</div>
        </div>
      </div>

      <div class="card">
        <div class="head">
          <div class="h">Settings & Info</div>
          <div class="pill">UI: <b style="color:var(--text)">Blue Glass</b></div>
        </div>
        <div class="content">
          <div class="stat" style="margin-bottom:12px;">
            <div class="k">How it works</div>
            <div class="mini" style="margin-top:10px; color:var(--muted);">
              • Ping: request kecil ke <b>/ping</b><br/>
              • Download: stream data dari <b>/down</b><br/>
              • Upload: kirim blob ke <b>/up</b><br/>
              Semua dihitung realtime (Mbps) + diplot ke chart.
            </div>
          </div>

          <div class="stat">
            <div class="k">Tips biar akurat</div>
            <div class="mini" style="margin-top:10px;">
              • Tutup download lain (YouTube, update, dsb)<br/>
              • Test 2–3x ambil rata-rata<br/>
              • Pakai browser modern (Chrome/Edge/Firefox)
            </div>
          </div>

          <div class="stat" style="margin-top:12px;">
            <div class="k">Safety</div>
            <div class="mini" style="margin-top:10px;">
              Upload cuma “dibuang” di server (nggak disimpan).<br/>
              Data cap bikin test berhenti otomatis.
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
  const pingVal = document.getElementById("pingVal");
  const downVal = document.getElementById("downVal");
  const upVal = document.getElementById("upVal");
  const downNote = document.getElementById("downNote");
  const upNote = document.getElementById("upNote");
  const logEl = document.getElementById("log");
  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const modeSel = document.getElementById("mode");
  const capSel = document.getElementById("cap");
  const statusText = document.getElementById("statusText");
  const statusDot = document.getElementById("statusDot");

  const canvas = document.getElementById("chart");
  const ctx = canvas.getContext("2d");

  let running = false;
  let aborter = null;
  let pingTimer = null;

  // chart data
  const points = []; // {t, down, up}
  function resizeCanvas(){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    drawChart();
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  function setStatus(s){
    statusText.textContent = s;
    if(s === "Idle"){
      statusDot.style.background = "rgba(255,255,255,.35)";
    } else if(s.includes("Downloading")){
      statusDot.style.background = "rgba(74,163,255,.95)";
    } else if(s.includes("Uploading")){
      statusDot.style.background = "rgba(52,211,153,.95)";
    } else {
      statusDot.style.background = "rgba(251,191,36,.95)";
    }
  }
  function log(msg){
    logEl.textContent = msg;
  }

  // Real-time ping loop
  async function measurePingOnce(){
    const t0 = performance.now();
    try{
      await fetch(`/ping?cb=${Math.random()}`, { cache: "no-store" });
      const ms = performance.now() - t0;
      pingVal.textContent = Math.round(ms);
      return ms;
    }catch(e){
      pingVal.textContent = "--";
      return null;
    }
  }
  async function startPing(){
    if(pingTimer) return;
    await measurePingOnce();
    pingTimer = setInterval(measurePingOnce, 1000);
  }
  function stopPing(){
    if(pingTimer){ clearInterval(pingTimer); pingTimer = null; }
  }

  function fmtMbps(x){
    if(!isFinite(x)) return "--";
    return (x < 10 ? x.toFixed(2) : x < 100 ? x.toFixed(1) : x.toFixed(0));
  }

  function resetUI(){
    downVal.textContent = "--";
    upVal.textContent = "--";
    downNote.textContent = "—";
    upNote.textContent = "—";
  }

  function drawChart(){
    const w = canvas.clientWidth;
    const h = canvas.clientHeight;

    // clear
    ctx.clearRect(0,0,w,h);

    // background grid
    ctx.globalAlpha = 1;
    ctx.lineWidth = 1;
    ctx.strokeStyle = "rgba(255,255,255,.10)";
    for(let i=0;i<=4;i++){
      const y = 10 + (h-20)*(i/4);
      ctx.beginPath(); ctx.moveTo(10,y); ctx.lineTo(w-10,y); ctx.stroke();
    }

    // no data
    if(points.length < 2){
      ctx.fillStyle = "rgba(255,255,255,.55)";
      ctx.font = "12px ui-sans-serif, system-ui";
      ctx.fillText("Chart muncul pas test jalan…", 14, 22);
      return;
    }

    // scales
    const tMin = points[0].t;
    const tMax = points[points.length-1].t;
    let maxY = 10;
    for(const p of points){
      maxY = Math.max(maxY, p.down || 0, p.up || 0);
    }
    maxY = Math.max(10, maxY * 1.15);

    const xOf = (t)=> 10 + (w-20) * ((t - tMin) / Math.max(1, (tMax - tMin)));
    const yOf = (v)=> (h-10) - (h-20) * (v / maxY);

    // draw line helper
    function line(getV, color){
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      let started = false;
      for(const p of points){
        const v = getV(p);
        if(v == null) continue;
        const x = xOf(p.t);
        const y = yOf(v);
        if(!started){ ctx.moveTo(x,y); started = true; }
        else ctx.lineTo(x,y);
      }
      ctx.stroke();
    }

    // two lines (download + upload)
    line(p => p.down, "rgba(74,163,255,.95)");
    line(p => p.up, "rgba(52,211,153,.95)");

    // labels
    ctx.fillStyle = "rgba(255,255,255,.75)";
    ctx.font = "12px ui-sans-serif, system-ui";
    ctx.fillText(`Max ~ ${fmtMbps(maxY)} Mbps`, 14, h - 14);
    ctx.fillStyle = "rgba(74,163,255,.95)";
    ctx.fillText("Download", 14, 22);
    ctx.fillStyle = "rgba(52,211,153,.95)";
    ctx.fillText("Upload", 92, 22);
  }

  function pushPoint(down, up){
    const t = performance.now();
    points.push({ t, down, up });
    // keep last ~20s-ish points
    while(points.length > 200) points.shift();
    drawChart();
  }

  async function runDownload(bytesLimit, signal){
    setStatus("Downloading…");
    log("Running download test…");

    let downloaded = 0;
    let lastT = performance.now();
    let lastBytes = 0;
    const t0 = performance.now();

    const res = await fetch(`/down?bytes=${bytesLimit}&cb=${Math.random()}`, { cache: "no-store", signal });
    if(!res.body) throw new Error("Streaming not supported");

    const reader = res.body.getReader();
    while(true){
      const { value, done } = await reader.read();
      if(done) break;
      downloaded += value.byteLength;

      const now = performance.now();
      if(now - lastT >= 200){
        const deltaBytes = downloaded - lastBytes;
        const deltaTime = (now - lastT) / 1000;
        const mbps = (deltaBytes * 8) / (deltaTime * 1e6);

        downVal.textContent = fmtMbps(mbps);
        downNote.textContent = `${(downloaded/1024/1024).toFixed(1)} / ${(bytesLimit/1024/1024).toFixed(0)} MB`;

        pushPoint(mbps, null);

        lastT = now;
        lastBytes = downloaded;
      }
    }

    const elapsed = (performance.now() - t0) / 1000;
    const avg = (downloaded * 8) / (elapsed * 1e6);
    downVal.textContent = fmtMbps(avg);
    downNote.textContent = `Avg • ${(downloaded/1024/1024).toFixed(1)} MB • ${elapsed.toFixed(1)}s`;
    pushPoint(avg, null);
  }

  async function runUpload(bytesLimit, signal){
    setStatus("Uploading…");
    log("Running upload test…");

    const CHUNK = 1024 * 1024; // 1MB per request
    let uploaded = 0;

    let lastT = performance.now();
    let lastBytes = 0;
    const t0 = performance.now();

    while(uploaded < bytesLimit){
      const remaining = bytesLimit - uploaded;
      const size = Math.min(CHUNK, remaining);
      const payload = new Uint8Array(size);
      crypto.getRandomValues(payload);

      const nowStart = performance.now();
      await fetch(`/up?cb=${Math.random()}`, {
        method: "POST",
        body: payload,
        cache: "no-store",
        signal
      });

      uploaded += size;

      const now = performance.now();
      if(now - lastT >= 200){
        const deltaBytes = uploaded - lastBytes;
        const deltaTime = (now - lastT) / 1000;
        const mbps = (deltaBytes * 8) / (deltaTime * 1e6);

        upVal.textContent = fmtMbps(mbps);
        upNote.textContent = `${(uploaded/1024/1024).toFixed(1)} / ${(bytesLimit/1024/1024).toFixed(0)} MB`;

        pushPoint(null, mbps);

        lastT = now;
        lastBytes = uploaded;
      }
    }

    const elapsed = (performance.now() - t0) / 1000;
    const avg = (uploaded * 8) / (elapsed * 1e6);
    upVal.textContent = fmtMbps(avg);
    upNote.textContent = `Avg • ${(uploaded/1024/1024).toFixed(1)} MB • ${elapsed.toFixed(1)}s`;
    pushPoint(null, avg);
  }

  function setControlsEnabled(enabled){
    modeSel.disabled = !enabled;
    capSel.disabled = !enabled;
    startBtn.disabled = !enabled;
    stopBtn.disabled = enabled;
  }

  async function startTest(){
    if(running) return;
    running = true;
    aborter = new AbortController();
    setControlsEnabled(false);
    resetUI();
    points.length = 0;
    drawChart();

    const mode = modeSel.value;
    const capMB = parseInt(capSel.value, 10);
    const capBytes = capMB * 1024 * 1024;

    let downBytes = capBytes;
    let upBytes = capBytes;
    if(mode === "both"){
      downBytes = Math.floor(capBytes / 2);
      upBytes = capBytes - downBytes;
    }

    try{
      await startPing();

      if(mode === "download"){
        await runDownload(downBytes, aborter.signal);
        setStatus("Done");
        log("Done ✅ Download test finished.");
      } else if(mode === "upload"){
        await runUpload(upBytes, aborter.signal);
        setStatus("Done");
        log("Done ✅ Upload test finished.");
      } else {
        await runDownload(downBytes, aborter.signal);
        await runUpload(upBytes, aborter.signal);
        setStatus("Done");
        log("Done ✅ Download + Upload finished.");
      }
    }catch(e){
      if(e.name === "AbortError"){
        setStatus("Idle");
        log("Stopped. (dibatalin user)");
      }else{
        setStatus("Idle");
        log("Error: " + (e.message || e));
      }
    }finally{
      running = false;
      aborter = null;
      setControlsEnabled(true);
      setTimeout(()=> setStatus("Idle"), 800);
    }
  }

  function stopTest(){
    if(!running) return;
    aborter?.abort();
  }

  startBtn.addEventListener("click", startTest);
  stopBtn.addEventListener("click", stopTest);

  // start ping immediately
  setStatus("Idle");
  startPing();
</script>
</body>
</html>
