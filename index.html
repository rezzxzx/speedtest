<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Glassy Speed Test</title>
  <style>
    :root{
      --bg1:#07152b; --bg2:#0a2a5a;
      --glass: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --blue:#4aa3ff; --blue2:#2f7dff;
      --green:#34d399; --amber:#fbbf24;
      --shadow: 0 16px 50px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(74,163,255,.35), transparent 55%),
        radial-gradient(900px 700px at 80% 20%, rgba(47,125,255,.25), transparent 55%),
        radial-gradient(800px 600px at 50% 90%, rgba(255,255,255,.07), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }
    .wrap{max-width:1150px;margin:0 auto;padding:26px 16px 40px;}
    .topbar{display:flex;gap:14px;align-items:center;justify-content:space-between;margin-bottom:18px;}
    .brand{display:flex;gap:12px;align-items:center;}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, rgba(74,163,255,.9), rgba(47,125,255,.75));
      box-shadow: 0 10px 30px rgba(74,163,255,.25);
      position:relative;overflow:hidden;
    }
    .logo::after{
      content:"";position:absolute;inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 55%);
      transform: rotate(20deg);opacity:.75;
    }
    .title h1{margin:0;font-size:18px;letter-spacing:.2px;line-height:1.1}
    .title p{margin:3px 0 0;color:var(--muted);font-size:12px}
    .pill{
      font-size:12px;padding:7px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--muted);display:inline-flex;align-items:center;gap:8px;white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:99px;background: rgba(255,255,255,.35);box-shadow: 0 0 0 4px rgba(255,255,255,.06);}
    .grid{display:grid;grid-template-columns: 1.1fr .9fr;gap:16px;}
    @media (max-width: 960px){ .grid{grid-template-columns: 1fr;} }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.06));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      overflow:hidden;
    }
    .head{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.10);display:flex;justify-content:space-between;align-items:center;gap:10px;}
    .head .h{font-weight:900;font-size:13px;letter-spacing:.3px;}
    .content{padding:16px;}
    .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:12px;}
    @media (max-width:560px){ .row{grid-template-columns:1fr;} }
    .stat{
      padding:14px;border-radius:16px;border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
    }
    .k{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;align-items:center;gap:10px;}
    .v{margin-top:8px;font-size:28px;font-weight:950;letter-spacing:.2px;}
    .unit{font-size:12px;color:var(--muted);font-weight:800;}
    .mini{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.35}
    .controls{display:grid;grid-template-columns: 1.2fr 1fr 1fr;gap:12px;margin-top:12px;}
    @media (max-width: 820px){ .controls{grid-template-columns:1fr;} }
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px 2px;}
    select, input, button{
      width:100%; border-radius:14px; outline:none;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:12px 12px; font-size:14px;
    }
    input::placeholder{color: rgba(255,255,255,.45)}
    select:disabled, input:disabled, button:disabled{opacity:.55;cursor:not-allowed;}
    button{
      font-weight:950;border:none;
      background: linear-gradient(135deg, rgba(74,163,255,.95), rgba(47,125,255,.85));
      box-shadow: 0 14px 30px rgba(47,125,255,.25);
      cursor:pointer; transition: transform .08s ease;
    }
    button:active{ transform: translateY(1px) scale(.995); }
    .btn2{
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.16);
      box-shadow:none;
      font-weight:900;
    }
    .two{display:grid;grid-template-columns: 1fr 1fr;gap:12px;margin-top:12px;}
    @media (max-width: 960px){ .two{grid-template-columns:1fr;} }

    .gaugeWrap{
      border-radius:16px;border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04); padding:10px; height:240px;
      position:relative;
    }
    .gLabel{
      position:absolute; left:14px; top:12px;
      color: rgba(255,255,255,.78); font-size:12px; font-weight:950;
      letter-spacing:.2px;
    }
    .gValue{
      position:absolute; left:14px; bottom:14px;
      font-size:26px; font-weight:980; letter-spacing:.2px;
    }
    .gValue span{font-size:12px;color:var(--muted);font-weight:900;margin-left:6px;}

    .chartWrap{
      border-radius:16px;border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04); padding:10px; height:240px;
    }
    canvas{width:100%;height:100%;display:block;}

    .log{
      margin-top:12px; padding:12px 14px;
      border-radius:16px; border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12); color:var(--muted);
      font-size:12px; line-height:1.45; white-space:pre-wrap; min-height:52px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.78);
      font-size:12px; font-weight:950;
    }
    .muted{color:var(--muted); font-weight:900}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <h1>Glassy Speed Test</h1>
          <p>Ping real-time • Gauge • Chart • Data cap custom • Average per sesi • IP/Provider/Device</p>
        </div>
      </div>
      <div class="pill"><span class="dot" id="statusDot"></span><span id="statusText">Idle</span></div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="head">
          <div class="h">Live Results</div>
          <div class="pill">Host: <b style="color:var(--text)">Vercel</b></div>
        </div>
        <div class="content">

          <div class="row">
            <div class="stat">
              <div class="k">Ping <span class="unit">ms</span></div>
              <div class="v" id="pingVal">--</div>
              <div class="mini" id="pingNote">real-time</div>
            </div>
            <div class="stat">
              <div class="k">Download <span class="unit">Mbps</span></div>
              <div class="v" id="downVal">--</div>
              <div class="mini" id="downNote">—</div>
            </div>
            <div class="stat">
              <div class="k">Upload <span class="unit">Mbps</span></div>
              <div class="v" id="upVal">--</div>
              <div class="mini" id="upNote">—</div>
            </div>
          </div>

          <!-- Average per sesi (reset pas refresh/keluar) -->
          <div class="row" style="margin-top:8px;">
            <div class="stat">
              <div class="k">Average Download <span class="unit">Mbps</span></div>
              <div class="v" id="avgDownVal">--</div>
              <div class="mini" id="avgCountNote">Dari 0x test</div>
            </div>
            <div class="stat">
              <div class="k">Average Upload <span class="unit">Mbps</span></div>
              <div class="v" id="avgUpVal">--</div>
              <div class="mini" id="avgUpNote">—</div>
            </div>
            <div class="stat">
              <div class="k">History (sesi ini)</div>
              <div class="mini" id="lastRunNote" style="margin-top:10px;">Belum ada data.</div>
              <button id="clearHistoryBtn" class="btn2" style="margin-top:10px;">Clear (Sesi)</button>
            </div>
          </div>

          <div class="two">
            <div class="gaugeWrap">
              <div class="gLabel" id="gMode">Gauge</div>
              <canvas id="gauge"></canvas>
              <div class="gValue" id="gValue">0.00 <span>Mbps</span></div>
            </div>
            <div class="chartWrap">
              <canvas id="chart"></canvas>
            </div>
          </div>

          <div class="controls">
            <div>
              <label>Mode test</label>
              <select id="mode">
                <option value="download">Download</option>
                <option value="upload">Upload</option>
                <option value="both">Download + Upload</option>
              </select>
            </div>
            <div>
              <label>Data cap (MB) — custom (default 100)</label>
              <input id="capMb" type="number" min="1" max="2000" value="100" placeholder="contoh: 100" />
              <div class="mini">Auto stop kalau data udah kepake sesuai angka ini.</div>
            </div>
            <div>
              <label>Kontrol</label>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <button id="startBtn">Start Test</button>
                <button id="stopBtn" class="btn2" disabled>Stop</button>
              </div>
            </div>
          </div>

          <div class="log" id="log">Ready.</div>
          <div class="mini">Catatan: mode “Both” = cap dibagi 2 (contoh 100MB → 50MB download + 50MB upload).</div>
        </div>
      </div>

      <div class="card">
        <div class="head">
          <div class="h">IP • Provider • Device</div>
          <div class="pill">Info: <b style="color:var(--text)">Live</b></div>
        </div>
        <div class="content">
          <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:12px;">
            <div class="badge">IP: <span class="muted" id="ipVal">—</span></div>
            <div class="badge">Provider: <span class="muted" id="ispVal">—</span></div>
            <div class="badge">Device: <span class="muted" id="devVal">—</span></div>
          </div>

          <div class="stat" style="margin-bottom:12px;">
            <div class="k">Lokasi (perkiraan)</div>
            <div class="mini" id="locVal" style="margin-top:10px;">—</div>
          </div>

          <div class="stat">
            <div class="k">Catatan akurasi</div>
            <div class="mini" style="margin-top:10px;">
              Ini estimasi yang “cukup oke” buat cek cepat. Kalau mau super akurat,
              pindahin endpoint ke VPS dedicated.
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

<script>
  // ===== Elements
  const pingVal = document.getElementById("pingVal");
  const downVal = document.getElementById("downVal");
  const upVal = document.getElementById("upVal");
  const downNote = document.getElementById("downNote");
  const upNote = document.getElementById("upNote");
  const logEl = document.getElementById("log");
  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const modeSel = document.getElementById("mode");
  const capInput = document.getElementById("capMb");
  const statusText = document.getElementById("statusText");
  const statusDot = document.getElementById("statusDot");

  const ipVal = document.getElementById("ipVal");
  const ispVal = document.getElementById("ispVal");
  const devVal = document.getElementById("devVal");
  const locVal = document.getElementById("locVal");

  const avgDownVal = document.getElementById("avgDownVal");
  const avgUpVal = document.getElementById("avgUpVal");
  const avgCountNote = document.getElementById("avgCountNote");
  const avgUpNote = document.getElementById("avgUpNote");
  const lastRunNote = document.getElementById("lastRunNote");
  const clearHistoryBtn = document.getElementById("clearHistoryBtn");

  const chartCanvas = document.getElementById("chart");
  const chartCtx = chartCanvas.getContext("2d");

  const gaugeCanvas = document.getElementById("gauge");
  const gaugeCtx = gaugeCanvas.getContext("2d");
  const gValueEl = document.getElementById("gValue");
  const gModeEl = document.getElementById("gMode");

  let running = false;
  let aborter = null;
  let pingTimer = null;

  // ===== Helpers
  function fmtMbps(x){
    if(!isFinite(x)) return "--";
    return (x < 10 ? x.toFixed(2) : x < 100 ? x.toFixed(1) : x.toFixed(0));
  }
  function log(msg){ logEl.textContent = msg; }
  function setStatus(s){
    statusText.textContent = s;
    if(s === "Idle"){ statusDot.style.background = "rgba(255,255,255,.35)"; }
    else if(s.includes("Downloading")){ statusDot.style.background = "rgba(74,163,255,.95)"; }
    else if(s.includes("Uploading")){ statusDot.style.background = "rgba(52,211,153,.95)"; }
    else { statusDot.style.background = "rgba(251,191,36,.95)"; }
  }
  function setControlsEnabled(enabled){
    modeSel.disabled = !enabled;
    capInput.disabled = !enabled;
    startBtn.disabled = !enabled;
    stopBtn.disabled = enabled;
  }
  function resetUI(){
    downVal.textContent = "--"; upVal.textContent = "--";
    downNote.textContent = "—"; upNote.textContent = "—";
    setGauge(0, "Idle");
  }

  // ===== Session history (auto hilang pas refresh/keluar)
  const SESSION_KEY = "speedtest_session_history_v1";

  function loadHistory(){
    try{
      const raw = sessionStorage.getItem(SESSION_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch{
      return [];
    }
  }
  function saveHistory(arr){
    try{ sessionStorage.setItem(SESSION_KEY, JSON.stringify(arr)); }catch{}
  }
  function mean(nums){
    const v = nums.filter(n => typeof n === "number" && isFinite(n));
    if(!v.length) return null;
    return v.reduce((a,b)=>a+b,0) / v.length;
  }
  function updateAveragesUI(arr = loadHistory()){
    const n = arr.length;
    avgCountNote.textContent = `Dari ${n}x test`;

    if(!n){
      avgDownVal.textContent = "--";
      avgUpVal.textContent = "--";
      avgUpNote.textContent = "—";
      lastRunNote.textContent = "Belum ada data.";
      return;
    }

    const downList = arr.map(x => x.downAvg).filter(v => typeof v === "number");
    const upList   = arr.map(x => x.upAvg).filter(v => typeof v === "number");

    const downAvgAll = mean(downList);
    const upAvgAll   = mean(upList);

    avgDownVal.textContent = downAvgAll == null ? "--" : fmtMbps(downAvgAll);
    avgUpVal.textContent   = upAvgAll == null ? "--" : fmtMbps(upAvgAll);
    avgUpNote.textContent  = `Upload data: ${upList.length} run`;

    const last = arr[arr.length - 1];
    const when = new Date(last.ts).toLocaleString();
    lastRunNote.textContent =
      `Last: ${last.mode} • cap ${last.capMb}MB • Down ${last.downAvg != null ? fmtMbps(last.downAvg) : "--"} • Up ${last.upAvg != null ? fmtMbps(last.upAvg) : "--"} • ${when}`;
  }
  function addResultToHistory(result){
    const arr = loadHistory();
    arr.push(result);
    while(arr.length > 50) arr.shift(); // biar gak kebanyakan dalam 1 sesi
    saveHistory(arr);
    updateAveragesUI(arr);
  }

  clearHistoryBtn.addEventListener("click", () => {
    sessionStorage.removeItem(SESSION_KEY);
    updateAveragesUI([]);
  });

  // ===== Ping (real-time)
  async function measurePingOnce(){
    const t0 = performance.now();
    try{
      await fetch(`/ping?cb=${Math.random()}`, { cache: "no-store" });
      const ms = performance.now() - t0;
      pingVal.textContent = Math.round(ms);
      return ms;
    }catch{
      pingVal.textContent = "--";
      return null;
    }
  }
  async function startPing(){
    if(pingTimer) return;
    await measurePingOnce();
    pingTimer = setInterval(measurePingOnce, 1000);
  }

  // ===== Device info (simple UA parse)
  function getDeviceLabel(){
    const ua = navigator.userAgent || "";
    const isAndroid = /Android/i.test(ua);
    const isiOS = /iPhone|iPad|iPod/i.test(ua);
    const isWin = /Windows NT/i.test(ua);
    const isMac = /Macintosh/i.test(ua) && !isiOS;
    const isLinux = /Linux/i.test(ua) && !isAndroid;
    const isMobile = /Mobi/i.test(ua) || isAndroid || isiOS;

    let os = isAndroid ? "Android" : isiOS ? "iOS" : isWin ? "Windows" : isMac ? "macOS" : isLinux ? "Linux" : "Unknown OS";
    let dev = isMobile ? "Mobile" : "Desktop";

    let br = "Browser";
    if(/Edg\//.test(ua)) br = "Edge";
    else if(/Chrome\//.test(ua)) br = "Chrome";
    else if(/Firefox\//.test(ua)) br = "Firefox";
    else if(/Safari\//.test(ua) && !/Chrome\//.test(ua)) br = "Safari";

    return `${dev} • ${os} • ${br}`;
  }

  async function loadInfo(){
    devVal.textContent = getDeviceLabel();
    try{
      const r = await fetch("/info", { cache: "no-store" });
      const j = await r.json();
      ipVal.textContent = j.ip || "—";
      ispVal.textContent = (j.isp || j.org || "—");
      const parts = [j.city, j.region, j.country].filter(Boolean);
      locVal.textContent = parts.length ? parts.join(", ") : "—";
    }catch{
      ipVal.textContent = "—";
      ispVal.textContent = "—";
      locVal.textContent = "—";
    }
  }

  // ===== Chart
  const points = []; // {t, down, up}
  function resizeCanvas(c){
    const dpr = window.devicePixelRatio || 1;
    const rect = c.getBoundingClientRect();
    c.width = Math.floor(rect.width * dpr);
    c.height = Math.floor(rect.height * dpr);
    const ctx = c.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  function initCanvases(){
    resizeCanvas(chartCanvas);
    resizeCanvas(gaugeCanvas);
    drawChart();
    drawGauge();
  }
  window.addEventListener("resize", initCanvases);

  function pushPoint(down, up){
    points.push({ t: performance.now(), down, up });
    while(points.length > 220) points.shift();
    drawChart();
  }

  function drawChart(){
    const w = chartCanvas.clientWidth, h = chartCanvas.clientHeight;
    chartCtx.clearRect(0,0,w,h);

    chartCtx.lineWidth = 1;
    chartCtx.strokeStyle = "rgba(255,255,255,.10)";
    for(let i=0;i<=4;i++){
      const y = 10 + (h-20)*(i/4);
      chartCtx.beginPath(); chartCtx.moveTo(10,y); chartCtx.lineTo(w-10,y); chartCtx.stroke();
    }

    if(points.length < 2){
      chartCtx.fillStyle = "rgba(255,255,255,.55)";
      chartCtx.font = "12px ui-sans-serif, system-ui";
      chartCtx.fillText("Chart muncul pas test jalan…", 14, 22);
      return;
    }

    const tMin = points[0].t, tMax = points[points.length-1].t;
    let maxY = 10;
    for(const p of points){
      if(p.down != null) maxY = Math.max(maxY, p.down);
      if(p.up != null) maxY = Math.max(maxY, p.up);
    }
    maxY = Math.max(10, maxY * 1.2);

    const xOf = (t)=> 10 + (w-20) * ((t - tMin) / Math.max(1, (tMax - tMin)));
    const yOf = (v)=> (h-10) - (h-20) * (v / maxY);

    function line(getV, color){
      chartCtx.strokeStyle = color;
      chartCtx.lineWidth = 2;
      chartCtx.beginPath();
      let started = false;
      for(const p of points){
        const v = getV(p);
        if(v == null) continue;
        const x = xOf(p.t), y = yOf(v);
        if(!started){ chartCtx.moveTo(x,y); started = true; }
        else chartCtx.lineTo(x,y);
      }
      chartCtx.stroke();
    }

    line(p => p.down, "rgba(74,163,255,.95)");
    line(p => p.up, "rgba(52,211,153,.95)");

    chartCtx.fillStyle = "rgba(74,163,255,.95)";
    chartCtx.font = "12px ui-sans-serif, system-ui";
    chartCtx.fillText("Download", 14, 22);
    chartCtx.fillStyle = "rgba(52,211,153,.95)";
    chartCtx.fillText("Upload", 92, 22);

    chartCtx.fillStyle = "rgba(255,255,255,.7)";
    chartCtx.fillText(`Max ~ ${fmtMbps(maxY)} Mbps`, 14, h - 14);
  }

  // ===== Gauge
  let gaugeValue = 0;
  let gaugeTarget = 0;
  let gaugeLabel = "Idle";
  let gaugeMax = 300;

  function setGauge(mbps, label){
    gaugeTarget = Math.max(0, mbps || 0);
    gaugeLabel = label || gaugeLabel;

    const nice = [50, 100, 200, 300, 500, 800, 1000];
    const need = Math.max(50, gaugeTarget * 1.25);
    gaugeMax = nice.find(n => n >= need) || 1000;

    gModeEl.textContent = gaugeLabel;
  }

  function drawGauge(){
    const w = gaugeCanvas.clientWidth, h = gaugeCanvas.clientHeight;
    gaugeCtx.clearRect(0,0,w,h);

    const cx = w/2, cy = h*0.88;
    const r = Math.min(w, h) * 0.42;

    const start = Math.PI * 1.05;
    const end = Math.PI * 1.95;

    gaugeCtx.lineWidth = 14;
    gaugeCtx.lineCap = "round";
    gaugeCtx.strokeStyle = "rgba(255,255,255,.12)";
    gaugeCtx.beginPath();
    gaugeCtx.arc(cx, cy, r, start, end);
    gaugeCtx.stroke();

    const p = Math.min(1, gaugeValue / gaugeMax);
    const mid = start + (end - start) * p;

    let col = "rgba(74,163,255,.95)";
    if(gaugeLabel.includes("Upload")) col = "rgba(52,211,153,.95)";
    if(gaugeLabel === "Idle") col = "rgba(255,255,255,.35)";

    gaugeCtx.strokeStyle = col;
    gaugeCtx.beginPath();
    gaugeCtx.arc(cx, cy, r, start, mid);
    gaugeCtx.stroke();

    gaugeCtx.lineWidth = 2;
    gaugeCtx.strokeStyle = "rgba(255,255,255,.14)";
    for(let i=0;i<=10;i++){
      const a = start + (end - start) * (i/10);
      const x1 = cx + Math.cos(a) * (r - 22);
      const y1 = cy + Math.sin(a) * (r - 22);
      const x2 = cx + Math.cos(a) * (r - 10);
      const y2 = cy + Math.sin(a) * (r - 10);
      gaugeCtx.beginPath();
      gaugeCtx.moveTo(x1,y1);
      gaugeCtx.lineTo(x2,y2);
      gaugeCtx.stroke();
    }

    const needleA = start + (end - start) * p;
    const nx = cx + Math.cos(needleA) * (r - 34);
    const ny = cy + Math.sin(needleA) * (r - 34);

    gaugeCtx.strokeStyle = "rgba(255,255,255,.85)";
    gaugeCtx.lineWidth = 3;
    gaugeCtx.beginPath();
    gaugeCtx.moveTo(cx, cy);
    gaugeCtx.lineTo(nx, ny);
    gaugeCtx.stroke();

    gaugeCtx.fillStyle = "rgba(255,255,255,.85)";
    gaugeCtx.beginPath();
    gaugeCtx.arc(cx, cy, 6, 0, Math.PI*2);
    gaugeCtx.fill();

    gaugeCtx.fillStyle = "rgba(255,255,255,.65)";
    gaugeCtx.font = "12px ui-sans-serif, system-ui";
    gaugeCtx.fillText(`0`, cx - r + 6, cy + 12);
    const maxTxt = `${gaugeMax}`;
    const tw = gaugeCtx.measureText(maxTxt).width;
    gaugeCtx.fillText(maxTxt, cx + r - tw - 6, cy + 12);
  }

  function animateGauge(){
    gaugeValue += (gaugeTarget - gaugeValue) * 0.18;
    if(Math.abs(gaugeTarget - gaugeValue) < 0.02) gaugeValue = gaugeTarget;

    gValueEl.firstChild.textContent = `${fmtMbps(gaugeValue)}`;
    drawGauge();
    requestAnimationFrame(animateGauge);
  }

  // ===== Tests
  async function runDownload(bytesLimit, signal){
    setStatus("Downloading…");
    log("Running download test…");
    setGauge(0, "Downloading");

    let downloaded = 0;
    let lastT = performance.now();
    let lastBytes = 0;
    const t0 = performance.now();

    const res = await fetch(`/down?bytes=${bytesLimit}&cb=${Math.random()}`, { cache: "no-store", signal });
    if(!res.body) throw new Error("Streaming not supported");

    const reader = res.body.getReader();
    while(true){
      const { value, done } = await reader.read();
      if(done) break;
      downloaded += value.byteLength;

      const now = performance.now();
      if(now - lastT >= 200){
        const deltaBytes = downloaded - lastBytes;
        const deltaTime = (now - lastT) / 1000;
        const mbps = (deltaBytes * 8) / (deltaTime * 1e6);

        downVal.textContent = fmtMbps(mbps);
        downNote.textContent = `${(downloaded/1024/1024).toFixed(1)} / ${(bytesLimit/1024/1024).toFixed(1)} MB`;

        setGauge(mbps, "Downloading");
        pushPoint(mbps, null);

        lastT = now;
        lastBytes = downloaded;
      }
    }

    const elapsed = (performance.now() - t0) / 1000;
    const avg = (downloaded * 8) / (elapsed * 1e6);
    downVal.textContent = fmtMbps(avg);
    downNote.textContent = `Avg • ${(downloaded/1024/1024).toFixed(1)} MB • ${elapsed.toFixed(1)}s`;
    setGauge(avg, "Download Avg");
    pushPoint(avg, null);
    return avg;
  }

  async function runUpload(bytesLimit, signal){
    setStatus("Uploading…");
    log("Running upload test…");
    setGauge(0, "Uploading");

    const CHUNK = 1024 * 1024; // 1MB
    let uploaded = 0;

    let lastT = performance.now();
    let lastBytes = 0;
    const t0 = performance.now();

    while(uploaded < bytesLimit){
      const remaining = bytesLimit - uploaded;
      const size = Math.min(CHUNK, remaining);
      const payload = new Uint8Array(size);
      crypto.getRandomValues(payload);

      await fetch(`/up?cb=${Math.random()}`, {
        method: "POST",
        body: payload,
        cache: "no-store",
        signal
      });

      uploaded += size;

      const now = performance.now();
      if(now - lastT >= 220){
        const deltaBytes = uploaded - lastBytes;
        const deltaTime = (now - lastT) / 1000;
        const mbps = (deltaBytes * 8) / (deltaTime * 1e6);

        upVal.textContent = fmtMbps(mbps);
        upNote.textContent = `${(uploaded/1024/1024).toFixed(1)} / ${(bytesLimit/1024/1024).toFixed(1)} MB`;

        setGauge(mbps, "Uploading");
        pushPoint(null, mbps);

        lastT = now;
        lastBytes = uploaded;
      }
    }

    const elapsed = (performance.now() - t0) / 1000;
    const avg = (uploaded * 8) / (elapsed * 1e6);
    upVal.textContent = fmtMbps(avg);
    upNote.textContent = `Avg • ${(uploaded/1024/1024).toFixed(1)} MB • ${elapsed.toFixed(1)}s`;
    setGauge(avg, "Upload Avg");
    pushPoint(null, avg);
    return avg;
  }

  async function startTest(){
    if(running) return;
    running = true;
    aborter = new AbortController();
    setControlsEnabled(false);
    resetUI();
    points.length = 0;
    drawChart();

    const mode = modeSel.value;
    const capMb = Math.max(1, Math.min(2000, parseFloat(capInput.value || "100")));
    capInput.value = capMb;

    const capBytes = Math.floor(capMb * 1024 * 1024);
    let downBytes = capBytes, upBytes = capBytes;
    if(mode === "both"){
      downBytes = Math.floor(capBytes / 2);
      upBytes = capBytes - downBytes;
    }

    let downAvg = null;
    let upAvg = null;

    try{
      await startPing();

      if(mode === "download"){
        downAvg = await runDownload(downBytes, aborter.signal);
        setStatus("Done");
        log("Done ✅ Download finished.");
      } else if(mode === "upload"){
        upAvg = await runUpload(upBytes, aborter.signal);
        setStatus("Done");
        log("Done ✅ Upload finished.");
      } else {
        downAvg = await runDownload(downBytes, aborter.signal);
        upAvg = await runUpload(upBytes, aborter.signal);
        setStatus("Done");
        log("Done ✅ Download + Upload finished.");
      }

      addResultToHistory({
        ts: Date.now(),
        mode,
        capMb,
        downAvg,
        upAvg
      });

    }catch(e){
      if(e.name === "AbortError"){
        setStatus("Idle");
        log("Stopped. (dibatalin user)");
      }else{
        setStatus("Idle");
        log("Error: " + (e.message || e));
      }
    }finally{
      running = false;
      aborter = null;
      setControlsEnabled(true);
      setTimeout(()=> setStatus("Idle"), 800);
      setGauge(0, "Idle");
    }
  }

  function stopTest(){
    if(!running) return;
    aborter?.abort();
  }

  // ===== Wire
  startBtn.addEventListener("click", startTest);
  stopBtn.addEventListener("click", stopTest);

  // ===== Init
  setStatus("Idle");
  initCanvases();
  animateGauge();
  startPing();
  loadInfo();
  updateAveragesUI();
</script>
</body>
</html>
